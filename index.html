<!DOCTYPE html>
<html>
<head>
<title>Compass Example</title>

<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script type="text/javascript" charset="utf-8" src="cordova_stub.js"></script>


<script type="text/javascript" charset="utf-8">

var g_PI2       = Math.PI*2; // 2 x Pi
var g_toRAD     = 360/g_PI2; // Divide degrees by this to get radians
var g_watchH    = null;      // the current watchHeading (compass) callback identifier
var g_watchG    = null;      // the current watchPosition (GPS) callback identifier
var g_ArrHeight = 48;        // Height of drawn arrow
// Wait for device API libraries to load
//
//document.addEventListener("deviceready", onDeviceReady, false);

document.addEventListener("deviceready", onDeviceReady, false);

// device APIs are available, we can now access the sensor plugins
//
function onDeviceReady()
{
    var width = screen.width
    var height = screen.height
    document.getElementById('res').innerHTML = "res:"+width+"x"+height;
    var oc = document.getElementById('arrow');
    // Set the size of the canvas
    oc.width  = g_ArrHeight * 4;
    oc.height = g_ArrHeight * 4;
    startWatchH(); // start monitoring the compass
    startWatchG(); // start monitoring the GPS
}

// Start monitoring the compass
//
function startWatchH()
{
    // Update compass every 3 seconds
    var options = { frequency: 250 };
    g_watchH = navigator.compass.watchHeading(onSuccessH, onErrorH, options);
}


// Stop monitoring the compass
//
function stopWatchH()
{
    if (g_watchH)
        return;

    if (g_watchH) {
        navigator.compass.clearWatch(g_watchH);
        g_watchH = null;
    }
}

// Start monitoring the GPS
//
function startWatchG()
{
    // enableHighAccuracy:true will require the use of the GPS sensor
    if (g_watchG)
        return;

    var options = { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true }
    //g_watchG = navigator.geolocation.watchPosition(onSuccessG, onErrorG, options);
    getCoords();
}

function getCoords()
{
    var options = { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true }
    g_watchG = navigator.geolocation.getCurrentPosition(onSuccessG1, onErrorG1, options);    
}

function onSuccessG1(position)
{
    var element = document.getElementById('geolocation');
    element.innerHTML = 'Latitude: '  + position.coords.latitude  + '<br />' +
                        'Longitude: ' + position.coords.longitude
    setTimeout( getCoords, 1000 );
}

// onError: Failed to get the GPS data
//
function onErrorG1(positionError)
{
    writeError( 'geolocation_error', positionError);
}

// Stop monitoring the GPS
//
function stopWatchG()
{
    if (g_watchG) {
        navigator.geolocation.clearWatch(g_watchG);
        g_watchG = null;
    }
}

// onSuccessH: Get the current compass heading
//
function onSuccessH(heading)
{
    var element = document.getElementById('heading');
    element.innerHTML = 'Heading: ' + heading.magneticHeading;
    // We want the arrow to point to the same position (North) regardless
    // of the device orientation, so since the North heading is given 
    // relative to the top of the device, we'll point the arrow to
    // 2xPi (360 degrees) minus the heading of the top of the device.
    drawArrow(g_PI2-heading.magneticHeading/g_toRAD);
}

// onSuccessG: Get the current position from GPS
//
function onSuccessG(position)
{
    var element = document.getElementById('geolocation');
    element.innerHTML = 'Latitude: '  + position.coords.latitude  + '<br />' +
                        'Longitude: ' + position.coords.longitude
}

// onError: Failed to get the compass heading
//
function onErrorH(compassError)
{
    writeError( 'heading_error', compassError);
}

// onError: Failed to get the GPS data
//
function onErrorG(positionError)
{
    writeError( 'geolocation_error', positionError);
}

function writeError(id, err)
{
    var msg = "Code:" + err.code + ", message:" + err.message;
    document.getElementById(id).innerHTML = msg;
}

function drawArrow(r)
{
    var ctx = document.getElementById('arrow').getContext('2d');
    ctx.clearRect(0, 0, g_ArrHeight*4, g_ArrHeight*4);
    var state = ctx.save();
    var fulld3 = g_ArrHeight/3;
    var fulld2 = g_ArrHeight/2;
    ctx.translate(g_ArrHeight*2, g_ArrHeight*2);
    ctx.rotate(r);

    ctx.beginPath();
    ctx.strokeStyle = '#aaaaff';
    ctx.lineWidth = 5;

    ctx.moveTo(0, -g_ArrHeight);
    ctx.lineTo(g_ArrHeight, fulld3);
    ctx.lineTo(fulld2, fulld3);
    ctx.lineTo(fulld2, g_ArrHeight);
    ctx.lineTo(-fulld2, g_ArrHeight);
    ctx.lineTo(-fulld2, fulld3);
    ctx.lineTo(-g_ArrHeight, fulld3);

    ctx.closePath();
    ctx.stroke();
    ctx.fillStyle="#33ff33";
    ctx.fill();

    ctx.restore(state);
}

// http://www.yourhomenow.com/house/haversine.html

Number.prototype.toRad = function() {  // convert degrees to radians
  return this * Math.PI / 180;
}

Number.prototype.toDeg = function() {  // convert radians to degrees (signed)
  return this * 180 / Math.PI;
}

Number.prototype.toBrng = function() {  // convert radians to degrees (as bearing: 0...360)
  return (this.toDeg()+360) % 360;
}


function dist(lat1, lon1, lat2, lon2)
{
    var R = 6371;
    lat1 = lat1/g_toRAD; lat2 = lat2/g_toRAD;
    var londiff = (lon2-lon1)/g_toRAD;
    var d = Math.acos(Math.sin(lat1) * Math.sin(lat2) +
                    Math.cos(lat1)*
                    Math.cos(lat2) * 
                    Math.cos(londiff)) * R;
    return d;
}

function bearing(lat1, lon1, lat2, lon2)
{
    lat1 = lat1/g_toRAD; lat2 = lat2/g_toRAD;
    var londiff = (lon2-lon1)/g_toRAD;

    var y = Math.sin(dLon) * Math.cos(lat2);
    var x = Math.cos(lat1) * Math.sin(lat2) -
          Math.sin(lat1) * Math.cos(lat2)*Math.cos(londiff);
    var angle = Math.atan2(y, x);
    angle = angle * g_toRAD // back to degrees
    angle = (angle + 360) % 360
    return angle;
}

</script>
</head>
<body>
<div id="geolocation">Waiting for position...</div>
<button onclick="startWatchG();">Start Watching GPS</button>
<button onclick="stopWatchG();">Stop Watching GPS</button>

<br /><hr />

<div id="heading">Waiting for heading...</div>
<button onclick="startWatchH();">Start Watching Compass</button>
<button onclick="stopWatchH();">Stop Watching Compass</button>

<br /><hr />

<div id="res"></div>
<canvas id="arrow"></canvas>

<div id="geolocation_error"></div>
<div id="heading_error"></div>

</body>
</html>